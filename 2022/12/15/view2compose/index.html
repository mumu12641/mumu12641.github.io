<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>From View To Jetpack Compose | Muuuuu's Blog</title><meta name="author" content="muuuuu"><meta name="copyright" content="muuuuu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="From View To Jetpack Compose原生 View在 Android APP 中，所有的用户界面元素都是由 View 和 ViewGroup 的对象构成的。View 是绘制在屏幕上的用户能与之交互的一个对象。而 ViewGroup 则是一个用于存放其他 View（和 ViewGroup）对象的布局容器。 Android 为我们提供了一个 View 和 ViewGroup 子类的">
<meta property="og:type" content="article">
<meta property="og:title" content="From View To Jetpack Compose">
<meta property="og:url" content="http://example.com/2022/12/15/view2compose/index.html">
<meta property="og:site_name" content="Muuuuu&#39;s Blog">
<meta property="og:description" content="From View To Jetpack Compose原生 View在 Android APP 中，所有的用户界面元素都是由 View 和 ViewGroup 的对象构成的。View 是绘制在屏幕上的用户能与之交互的一个对象。而 ViewGroup 则是一个用于存放其他 View（和 ViewGroup）对象的布局容器。 Android 为我们提供了一个 View 和 ViewGroup 子类的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/banner.png">
<meta property="article:published_time" content="2022-12-15T03:09:39.867Z">
<meta property="article:modified_time" content="2022-12-15T03:09:49.584Z">
<meta property="article:author" content="muuuuu">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/banner.png"><link rel="shortcut icon" href="/img/icon.png"><link rel="canonical" href="http://example.com/2022/12/15/view2compose/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'From View To Jetpack Compose',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2022-12-15 11:09:49'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/icon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/banner.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Muuuuu's Blog</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">From View To Jetpack Compose</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-12-15T03:09:39.867Z" title="Created 2022-12-15 11:09:39">2022-12-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-12-15T03:09:49.584Z" title="Updated 2022-12-15 11:09:49">2022-12-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Programming/">Programming</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="From-View-To-Jetpack-Compose"><a href="#From-View-To-Jetpack-Compose" class="headerlink" title="From View To Jetpack Compose"></a>From View To Jetpack Compose</h1><h2 id="原生-View"><a href="#原生-View" class="headerlink" title="原生 View"></a>原生 View</h2><p>在 Android APP 中，所有的用户界面元素都是由 View 和 ViewGroup 的对象构成的。View 是绘制在屏幕上的用户能与之交互的一个对象。而 ViewGroup 则是一个用于存放其他 View（和 ViewGroup）对象的布局容器。 Android 为我们提供了一个 View 和 ViewGroup 子类的集合，集合中提供了一些常用的输入控件 (比如按钮和文本域) 和各种各样的布局模式。</p>
<p>原生 View 显示到我们的手机上面主要通过 Measure、layout、Draw 过程。</p>
<h3 id="Window、Activity、DecorView、ViewRoot"><a href="#Window、Activity、DecorView、ViewRoot" class="headerlink" title="Window、Activity、DecorView、ViewRoot"></a>Window、Activity、DecorView、ViewRoot</h3><p><strong>Activity</strong></p>
<p>Activity 并不负责视图控制，它只是控制生命周期和处理事件。真正控制视图的是 Window。一个 Activity 包含了一个 Window，Window 才是真正代表一个窗口。<strong>Activity 就像一个控制器，统筹视图的添加与显示，以及通过其他回调方法，来与 Window、以及 View 进行交互。</strong></p>
<p><strong>Window</strong></p>
<p>Window 是视图的承载器，内部持有一个 <strong>DecorView</strong>，而这个 DecorView 才是 view 的根布局。Window 是一个抽象类，实际在 Activity 中持有的是其子类 PhoneWindow。PhoneWindow 中有个内部类 DecorView，通过创建 DecorView 来加载 Activity 中设置的布局 <code>R.layout.activity_main</code>。Window 通过 WindowManager 将 DecorView 加载其中，并将 DecorView 交给 ViewRoot，进行视图绘制以及其他交互。</p>
<p><strong>DecorView</strong></p>
<p>DecorView 是 FrameLayout 的子类，它可以被认为是 Android 视图树的根节点视图。DecorView 作为顶级 View，一般情况下它内部包含一个竖直方向的 LinearLayout，**在这个 LinearLayout 里面有上下三个部分，上面是个 ViewStub，延迟加载的视图（应该是设置 ActionBar，根据 Theme 设置），中间的是标题栏 (根据 Theme 设置，有的布局没有)，下面的是内容栏 **</p>
<p><strong>ViewRoot</strong></p>
<p>ViewRoot 主要处理 View 的绘制以及事件分发等交互。</p>
<p>ViewRoot 对应 **ViewRootImpl 类，它是连接 WindowManagerService 和 DecorView 的纽带 **，View 的三大流程（测量（measure），布局（layout），绘制（draw））均通过 ViewRoot 来完成。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/7010367-4969918bb6d51d75.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/530/format/webp" alt="img"></p>
<h3 id="setContentView"><a href="#setContentView" class="headerlink" title="setContentView"></a>setContentView</h3><p>在 View 系统中，我们所编写的 xml 文件通过 <code>setContentView</code> 方法装载到视图。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContentView</span><span class="params">(<span class="meta">@LayoutRes</span> <span class="type">int</span> layoutResID)</span> &#123;</span><br><span class="line">	getWindow().setContentView(layoutResID);</span><br><span class="line">	initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们的 <code>xml</code> 文件是给到了 <code>Window</code> 去装载视图，即通过 <code>Activity</code> 持有的 <code>PhoneWindow</code> 中的 <code>DecorView</code> 装载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContentView</span><span class="params">(<span class="type">int</span> layoutResID)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="literal">null</span>) &#123;</span><br><span class="line">    	installDecor();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mContentParent.removeAllViews();</span><br><span class="line">    &#125;</span><br><span class="line">    mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Callback</span> <span class="variable">cb</span> <span class="operator">=</span> getCallback();</span><br><span class="line">    <span class="keyword">if</span> (cb != <span class="literal">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">        cb.onContentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个 <code>Window</code> 通过 <code>installDecor</code> 创建 <code>DecorView</code>，并且把我们的 <code>xml</code> 文件装载到 <code>mContentParent</code>，这个 <code>mContentParen</code>t 就是 <code>DecorView</code> 中的 <code>Content</code> 那部分的 <code>FrameLayout</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installDecor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mDecor == <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">    	<span class="comment">// 创建 DecorView</span></span><br><span class="line">        mDecor = generateDecor();</span><br><span class="line">        mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">        mDecor.setIsRootNamespace(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != <span class="number">0</span>) &#123;</span><br><span class="line">            mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="literal">null</span>) &#123;</span><br><span class="line">    	<span class="comment">// 为 DecorView 设置布局格式 并且返回 mContentParent</span></span><br><span class="line">        mContentParent = generateLayout(mDecor);</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上还只是加载了布局文件，<code>DecorView</code> 真正显示还要到 <code>Activity</code> 的 <code>onResume</code> 过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">handleResumeActivity</span><span class="params">(IBinder token, <span class="type">boolean</span> clearHide,</span></span><br><span class="line"><span class="params">                                <span class="type">boolean</span> isForward, <span class="type">boolean</span> reallyResume)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ActivityClientRecord</span> <span class="variable">r</span> <span class="operator">=</span> performResumeActivity(token, clearHide);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Activity</span> <span class="variable">a</span> <span class="operator">=</span> r.activity;</span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="literal">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">            r.window = r.activity.getWindow();</span><br><span class="line">            <span class="type">View</span> <span class="variable">decor</span> <span class="operator">=</span> r.window.getDecorView();</span><br><span class="line">            <span class="comment">//decor 不可见</span></span><br><span class="line">            decor.setVisibility(View.INVISIBLE);</span><br><span class="line">            <span class="type">ViewManager</span> <span class="variable">wm</span> <span class="operator">=</span> a.getWindowManager();</span><br><span class="line">            WindowManager.<span class="type">LayoutParams</span> <span class="variable">l</span> <span class="operator">=</span> r.window.getAttributes();</span><br><span class="line">            a.mDecor = decor;</span><br><span class="line"></span><br><span class="line">            l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">                a.mWindowAdded = <span class="literal">true</span>;</span><br><span class="line">                wm.addView(decor, l);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible</span><br><span class="line">                    &amp;&amp; r.activity.mDecor != <span class="literal">null</span> &amp;&amp; !r.hideForNow) &#123;</span><br><span class="line">                <span class="comment">// 真正可见</span></span><br><span class="line">                <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                    r.activity.makeVisible();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里在调用 <code>makeVisible</code> 方法之后才真正可见，在 <code>makeVisible</code> 方法中兜兜转转到最后 <code>WindowManager</code> 中的 <code>ViewRoot</code> 中去 <code>measure</code>、<code>layout</code>、<code>draw</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> &#123;</span><br><span class="line">               ...</span><br><span class="line">               <span class="comment">// Schedule the first layout -before- adding to the window</span></span><br><span class="line">               <span class="comment">// manager, to make sure we do the relayout before receiving</span></span><br><span class="line">               <span class="comment">// any other events from the system.</span></span><br><span class="line">               requestLayout();</span><br><span class="line">               ...</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">               ...</span><br><span class="line">                   res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                           getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">                           mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                           mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">               &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>ViewRootImpl 调用到 requestLayout 来完成 View 的绘制操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void requestLayout() &#123;</span><br><span class="line">       if (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">           checkThread();</span><br><span class="line">           mLayoutRequested = true;</span><br><span class="line">           scheduleTraversals();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>View 绘制，先判断当前线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">checkThread</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CalledFromWrongThreadException</span>(</span><br><span class="line">                    <span class="string">&quot;Only the original thread that created a view hierarchy can touch its views.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>最后兜兜转转到了 performTraversals 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performTraversals</span><span class="params">()</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">        ...</span><br><span class="line">        performLayout(lp, desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">        ......</span><br><span class="line">        performDraw();</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://camo.githubusercontent.com/14966d8fed302269718f4907f41dcd1da8e0dd67efdba49c1e2774cf437ba6b6/687474703a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f333938353536332d353832616165346665323764306233662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430" alt="img"></p>
<h3 id="Measure"><a href="#Measure" class="headerlink" title="Measure"></a>Measure</h3><p>Android View 的测量过程中使用到了 MeasureSpec（测量规格）。</p>
<p><img src="https://camo.githubusercontent.com/f3ae0d7d42fab0b57316a9a379c5bd7253e95535c04abd35266bc7806d375057/687474703a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f333938353536332d643362663039303561656238373139622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430" alt="img"></p>
<p>其中，Mode 模式共分为三类：</p>
<p><strong>UNSPECIFIED</strong> ：不对 View 进行任何限制，要多大给多大，一般用于系统内部</p>
<p><strong>EXACTLY</strong>：对应 LayoutParams 中的 match_parent 和具体数值这两种模式。检测到 View 所需要的精确大小，这时候 View 的最终大小就是 SpecSize 所指定的值，</p>
<p><strong>AT_MOST</strong> ：对应 LayoutParams 中的 wrap_content。View 的大小不能大于父容器的大小。</p>
<h4 id="MeasureSpec"><a href="#MeasureSpec" class="headerlink" title="MeasureSpec"></a>MeasureSpec</h4><p>对于 View 的 MeasureSpec，其确定是通过父布局的 MeasureSpec 和自身的布局参数 LayoutParams</p>
<p><img src="https://camo.githubusercontent.com/6140b113581f69dd02314dd2e27d730227f387c5d4b925e80fa56fed4beb217b/687474703a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f333938353536332d653366323063363636326566666237622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430" alt="img"></p>
<p>以上看来，View 的 MeasureSpec 要通过父容器 ViewGroup 的 getChildMeasureSpec 方法获取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getChildMeasureSpec</span><span class="params">(<span class="type">int</span> spec, <span class="type">int</span> padding, <span class="type">int</span> childDimension)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">specMode</span> <span class="operator">=</span> MeasureSpec.getMode(spec);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">specSize</span> <span class="operator">=</span> MeasureSpec.getSize(spec);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> Math.max(<span class="number">0</span>, specSize - padding);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">resultSize</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">resultMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        <span class="keyword">if</span> (childDimension&gt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line"></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line"></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">        <span class="keyword">if</span> (childDimension&gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;l</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        <span class="keyword">if</span> (childDimension&gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            resultSize = <span class="number">0</span>;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            resultSize = <span class="number">0</span>;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先我们来看 ViewGroup 的 <code>measure</code> 过程，对于 ViewGroup 没有 <code>onMeasure</code> 方法，只有 <code>measureChildren</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">measureChildren</span><span class="params">(<span class="type">int</span> widthMeasureSpec, <span class="type">int</span> heightMeasureSpec)</span> &#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> mChildrenCount;</span><br><span class="line">       <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">       <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="type">View</span> <span class="variable">child</span> <span class="operator">=</span> children[i];</span><br><span class="line">           <span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) != GONE) &#123;</span><br><span class="line">               measureChild(child, widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">measureChild</span><span class="params">(View child, <span class="type">int</span> parentWidthMeasureSpec,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> parentHeightMeasureSpec)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">LayoutParams</span> <span class="variable">lp</span> <span class="operator">=</span> child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">childWidthMeasureSpec</span> <span class="operator">=</span> getChildMeasureSpec(parentWidthMeasureSpec,</span><br><span class="line">                mPaddingLeft + mPaddingRight, lp.width);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">childHeightMeasureSpec</span> <span class="operator">=</span> getChildMeasureSpec(parentHeightMeasureSpec,</span><br><span class="line">                mPaddingTop + mPaddingBottom, lp.height);</span><br><span class="line"></span><br><span class="line">        child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>对于 View 的 <code>measure</code> 过程主要在于 <code>onMeasure</code> 方法，通过 <code>setMeasuredDimension</code> 方法设置测量值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMeasure</span><span class="params">(<span class="type">int</span> widthMeasureSpec, <span class="type">int</span> heightMeasureSpec)</span> &#123;</span><br><span class="line">        setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">                getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getDefaultSize</span><span class="params">(<span class="type">int</span> size, <span class="type">int</span> measureSpec)</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> size;</span><br><span class="line">  <span class="type">int</span> <span class="variable">specMode</span> <span class="operator">=</span> MeasureSpec.getMode(measureSpec);</span><br><span class="line">  <span class="type">int</span> <span class="variable">specSize</span> <span class="operator">=</span> MeasureSpec.getSize(measureSpec);</span><br><span class="line">  <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">      result = size;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">      result = specSize;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上 <code>getDefaultSize</code> 方法可以看到当 mode 为 <strong>AT_MOST</strong> 或者 <strong>EXACTLY</strong> 时，其实都是 specSize，但是结合上面的表我们可以知道，这时的 specSize 其实都是 parentSize，所以当我们自定义 View 的时候我们要重写 <code>onMeasure</code> 方法。</p>
<p>那么 ViewGroup 如何 Measure 自身呢？对于不同的 ViewGroup，Measure 方式都有所不同，具体我们等会自定义 View 的时候可以细看。</p>
<h3 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h3><p>测量完 View 大小之后，需要将 View 布局在 Window 中，View 的布局主要通过上下左右四个点来确定。</p>
<p><strong>其中布局也是自上而下，不同的是 ViewGroup 先在 layout() 中确定自己的布局，然后在 onLayout() 方法中再调用子 View 的 layout() 方法，让子 View 布局。在 Measure 过程中，ViewGroup 一般是先测量子 View 的大小，然后再确定自身的大小。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">layout</span><span class="params">(<span class="type">int</span> l, <span class="type">int</span> t, <span class="type">int</span> r, <span class="type">int</span> b)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">oldL</span> <span class="operator">=</span> mLeft;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldT</span> <span class="operator">=</span> mTop;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldB</span> <span class="operator">=</span> mBottom;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldR</span> <span class="operator">=</span> mRight;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setOpticalFrame	setFrame 确定自身布局</span></span><br><span class="line"> <span class="type">boolean</span> <span class="variable">changed</span> <span class="operator">=</span> isLayoutModeOptical(mParent) ?</span><br><span class="line">            setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// onLayout  确定子 View 布局</span></span><br><span class="line">        onLayout(changed, l, t, r, b);</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>onLayout</code> 是一个可重写的方法，<strong>如果当前 View 就是一个单一的 View，那么没有子 View，就不需要实现该方法。</strong></p>
<p><strong>如果当前 View 是一个 ViewGroup，就需要实现 onLayout 方法，在自定义 ViewGroup 的时候就需要自行实现 onLayout 方法布局子 View</strong></p>
<h3 id="Draw"><a href="#Draw" class="headerlink" title="Draw"></a>Draw</h3><p>View 的绘制过程遵循如下几步：</p>
<ol>
<li><p>绘制背景 background.draw(canvas)</p>
</li>
<li><p>绘制自己（onDraw）</p>
</li>
<li><p>绘制 Children(dispatchDraw)</p>
</li>
<li><p>绘制装饰（onDrawScrollBars）</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">int</span> saveCount;</span><br><span class="line">    <span class="keyword">if</span> (!dirtyOpaque) &#123;</span><br><span class="line">        drawBackground(canvas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">viewFlags</span> <span class="operator">=</span> mViewFlags;</span><br><span class="line">        <span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!dirtyOpaque)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 自定义 View 需要真正重写的方法</span></span><br><span class="line">            onDraw(canvas);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        dispatchDraw(canvas);</span><br><span class="line"></span><br><span class="line">        ........</span><br><span class="line"></span><br><span class="line">        onDrawScrollBars(canvas);</span><br><span class="line"></span><br><span class="line">       ..........</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>无论是 ViewGroup 还是单一的 View，都需要实现这套流程，不同的是，在 ViewGroup 中，实现了 dispatchDraw() 方法，而在单一子 View 中不需要实现该方法。自定义 View 一般要重写 onDraw() 方法，在其中绘制不同的样式。</strong></p>
<h3 id="自定义-View"><a href="#自定义-View" class="headerlink" title="自定义 View"></a>自定义 View</h3><p>有了前面的知识，我们可以着手实现一个自己 ViewGroup 和 View。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyViewGroup</span> <span class="keyword">extends</span> <span class="title class_">ViewGroup</span> &#123;</span><br><span class="line">    <span class="comment">// horizontal LinearLayout</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;DrawAllocation&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMeasure</span><span class="params">(<span class="type">int</span> widthMeasureSpec, <span class="type">int</span> heightMeasureSpec)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">childrenCount</span> <span class="operator">=</span> getChildCount();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">paddingLeft</span> <span class="operator">=</span> getPaddingLeft();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">paddingRight</span> <span class="operator">=</span> getPaddingRight();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">paddingTop</span> <span class="operator">=</span> getPaddingTop();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">paddingBottom</span> <span class="operator">=</span> getPaddingBottom();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">widthSize</span> <span class="operator">=</span> MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">        <span class="type">int</span> <span class="variable">widthMode</span> <span class="operator">=</span> MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">        <span class="type">int</span> <span class="variable">heightSize</span> <span class="operator">=</span> MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">        <span class="type">int</span> <span class="variable">heightMode</span> <span class="operator">=</span> MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">        <span class="type">int</span> <span class="variable">marginLeft</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">marginTop</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">marginRight</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">marginBottom</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">allChildrenWidth</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxChildrenHeight</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">View</span> <span class="variable">childView</span> <span class="operator">=</span> getChildAt(i);</span><br><span class="line">            ViewGroup.<span class="type">LayoutParams</span> <span class="variable">params</span> <span class="operator">=</span> childView.getLayoutParams();</span><br><span class="line">            ViewGroup.MarginLayoutParams marginParams;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (params <span class="keyword">instanceof</span> ViewGroup.MarginLayoutParams) &#123;</span><br><span class="line">                marginParams = (ViewGroup.MarginLayoutParams) params;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                marginParams = <span class="keyword">new</span> <span class="title class_">ViewGroup</span>.MarginLayoutParams(params);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            measureChild(childView, widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">            maxChildrenHeight = Math.max(maxChildrenHeight, childView.getMeasuredHeight());</span><br><span class="line">            allChildrenWidth += childView.getMeasuredWidth();</span><br><span class="line">            marginLeft += marginParams.leftMargin;</span><br><span class="line">            marginRight += marginParams.rightMargin;</span><br><span class="line">            marginBottom = Math.max(marginBottom, marginParams.bottomMargin);</span><br><span class="line">            marginTop = Math.max(marginTop, marginParams.topMargin);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (childrenCount == <span class="number">0</span>) &#123;</span><br><span class="line">            setMeasuredDimension(<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthMode == MeasureSpec.AT_MOST &amp;&amp; heightMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">            setMeasuredDimension(allChildrenWidth + paddingLeft + paddingRight + marginRight + marginLeft,</span><br><span class="line">                    maxChildrenHeight + paddingTop + paddingBottom + marginTop + marginBottom);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">            setMeasuredDimension(allChildrenWidth + paddingLeft + paddingRight + marginRight + marginLeft, heightSize);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heightMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">            setMeasuredDimension(widthSize, maxChildrenHeight + paddingTop + paddingBottom + marginTop + marginBottom);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;DrawAllocation&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onLayout</span><span class="params">(<span class="type">boolean</span> b, <span class="type">int</span> i, <span class="type">int</span> i1, <span class="type">int</span> i2, <span class="type">int</span> i3)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// layout children View</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">paddingLeft</span> <span class="operator">=</span> getPaddingLeft();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">paddingTop</span> <span class="operator">=</span> getPaddingTop();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">childrenCount</span> <span class="operator">=</span> getChildCount();</span><br><span class="line">        <span class="type">int</span> <span class="variable">childLeft</span> <span class="operator">=</span> paddingLeft;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</span><br><span class="line">            <span class="type">View</span> <span class="variable">childView</span> <span class="operator">=</span> getChildAt(j);</span><br><span class="line">            ViewGroup.<span class="type">LayoutParams</span> <span class="variable">params</span> <span class="operator">=</span> childView.getLayoutParams();</span><br><span class="line">            ViewGroup.MarginLayoutParams marginParams;</span><br><span class="line">            <span class="keyword">if</span> (params <span class="keyword">instanceof</span> ViewGroup.MarginLayoutParams) &#123;</span><br><span class="line">                marginParams = (ViewGroup.MarginLayoutParams) params;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                marginParams = <span class="keyword">new</span> <span class="title class_">ViewGroup</span>.MarginLayoutParams(params);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (childView.getVisibility() != GONE) &#123;</span><br><span class="line">                childView.layout(childLeft + marginParams.leftMargin,</span><br><span class="line">                        marginParams.topMargin + paddingTop,</span><br><span class="line">                        childLeft + childView.getMeasuredWidth(),</span><br><span class="line">                        childView.getMeasuredHeight() + paddingTop + marginParams.topMargin);</span><br><span class="line">                childLeft += (childView.getMeasuredWidth() + marginParams.rightMargin);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyView</span> <span class="keyword">extends</span> <span class="title class_">View</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> getWidth() - paddingLeft - paddingRight;</span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> getHeight() - paddingBottom - paddingTop;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressLint(&quot;DrawAllocation&quot;)</span> <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> BitmapFactory.decodeResource(mContext.getResources(), R.drawable.archlinux_logo_icon);</span><br><span class="line">        <span class="meta">@SuppressLint(&quot;DrawAllocation&quot;)</span> <span class="type">Rect</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Rect</span>(paddingLeft, paddingTop, paddingLeft + width, paddingTop + height);</span><br><span class="line">        canvas.drawBitmap(bitmap, src, src, mPaint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMeasure</span><span class="params">(<span class="type">int</span> widthMeasureSpec, <span class="type">int</span> heightMeasureSpec)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">        <span class="comment">// handle wrap_content</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">widthSize</span> <span class="operator">=</span> MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">        <span class="type">int</span> <span class="variable">widthMode</span> <span class="operator">=</span> MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">        <span class="type">int</span> <span class="variable">heightSize</span> <span class="operator">=</span> MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">        <span class="type">int</span> <span class="variable">heightMode</span> <span class="operator">=</span> MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">        <span class="keyword">if</span> (widthMode == MeasureSpec.AT_MOST &amp;&amp; heightMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">            setMeasuredDimension(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">            setMeasuredDimension(<span class="number">200</span>, heightSize);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heightMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">            setMeasuredDimension(widthSize, <span class="number">200</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结如下：</p>
<ul>
<li><p>从 View 的测量、布局和绘制原理来看，要实现自定义 View，根据自定义 View 的种类不同，可能分别要自定义实现不同的方法。但是这些方法不外乎：<strong>onMeasure() 方法，onLayout() 方法，onDraw() 方法。</strong></p>
</li>
<li><p>**onMeasure() 方法 **：单一 View，一般重写此方法，针对 wrap_content 情况，规定 View 默认的大小值，避免于 match_parent 情况一致。ViewGroup，若不重写，就会执行和单子 View 中相同逻辑，不会测量子 View。一般会重写 onMeasure() 方法，循环测量子 View。</p>
</li>
<li><p><strong>onLayout() 方法:</strong> 单一 View，不需要实现该方法。ViewGroup 必须实现，该方法是个抽象方法，实现该方法，来对子 View 进行布局。</p>
</li>
<li><p><strong>onDraw() 方法：</strong> 无论单一 View，或者 ViewGroup 都可以实现该方法。</p>
</li>
</ul>
<h2 id="Jetpack-Compose"><a href="#Jetpack-Compose" class="headerlink" title="Jetpack Compose"></a>Jetpack Compose</h2><p>Jetpack Compose 是用于构建原生 Android 界面的新工具包。它可简化并加快 Android 上的界面开发，使用更少的代码、强大的工具和直观的 Kotlin API，快速打造生动而精彩的应用。</p>
<blockquote>
<p>更少的代码、直观、加速开发、功能强大</p>
</blockquote>
<h3 id="声明式-UI"><a href="#声明式-UI" class="headerlink" title="声明式 UI"></a>声明式 UI</h3><p>在传统 View 中，我们通常需要使用 <code>findViewById</code> 方法拿到控件之后，再通过 <code>setText、setImageBitmap</code> 等方法更新界面的数据，这样手动操纵视图的方法会提高出错的可能性。如果一条数据在多个位置呈现，很容易忘记更新显示它的某个视图。此外，当两项更新以出人意料的方式发生冲突时，也很容易造成异常状态。</p>
<p>而 Jetpack Compose 作为声明式 UI，其技术的工作原理是在概念上从头开始重新生成整个屏幕，然后执行必要的更改，我们只需要声明每个控件需要的状态，在我们更新状态的时候，相应的控件会发生 <strong>重组</strong>，此方法可避免手动更新有状态视图层次结构的复杂性。</p>
<h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composeable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">Content</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> state <span class="keyword">by</span> remember &#123;mutableStateOf(<span class="number">0</span>) &#125;</span><br><span class="line">    StateContent(state)&#123;</span><br><span class="line">        state = state +<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">StateContent</span><span class="params">(state:<span class="type">Int</span>, add: () -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    Column &#123;</span><br><span class="line">        Text(text = state.toString())</span><br><span class="line">        Button(onClick = &#123; add() &#125;) &#123;</span><br><span class="line">			Text(<span class="string">&quot;Add&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配合-ViewModel-和-Flow-食用"><a href="#配合-ViewModel-和-Flow-食用" class="headerlink" title="配合 ViewModel 和 Flow 食用"></a>配合 ViewModel 和 Flow 食用</h3><p>上面的例子还是不够 MVVM，我们的 State 与事件应该保存在 ViewModel 中。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainViewModel</span> : <span class="type">ViewModel</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> _state = MutableStateFlow(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> state = _state</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">addNum</span><span class="params">()</span></span> &#123;</span><br><span class="line">        _state.value = _state.value + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">Content</span><span class="params">(mainViewModel: <span class="type">MainViewModel</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> state <span class="keyword">by</span> mainViewModel.state.collectAsState(initial = <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">   StateContent(state = state) &#123;</span><br><span class="line">		mainViewModel.addNum()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">StateContent</span><span class="params">(state: <span class="type">Int</span>, addNum: () -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    Column &#123;</span><br><span class="line">        Text(text = state.toString())</span><br><span class="line">        Button(onClick = &#123; addNum() &#125;) &#123;</span><br><span class="line">			Text(<span class="string">&quot;Add&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上的做法是 Google 官方推崇的最佳架构，即 <strong>数据单向流通，唯一可信源，状态向下传递，事件向上传递</strong></p>
<p><img src="https://developer.android.google.cn/static/images/jetpack/compose/mmodel-flow-data.png" alt="Compose 界面中数据从高级对象向下流向其子级的图示。" style="zoom: 20%;" /><img src="https://developer.android.google.cn/static/images/jetpack/compose/mmodel-flow-events.png" alt="说明界面元素如何通过触发由应用逻辑处理的事件来响应交互的图示。" style="zoom: 20%;" /></p>
<h3 id="重组原理以及性能优化"><a href="#重组原理以及性能优化" class="headerlink" title="重组原理以及性能优化"></a>重组原理以及性能优化</h3><h4 id="Composable-的本质"><a href="#Composable-的本质" class="headerlink" title="Composable 的本质"></a>Composable 的本质</h4><p>在 Compose 中，普通的函数通过 Composable 注解就变成了构建 UI 的可组合函数，具体其是通过 Compose Compiler Plugin 实现的。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">Greeting</span><span class="params">(msg: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">	Text(text = <span class="string">&quot;Hello <span class="variable">$msg</span>!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 Compose Compiler Plugin 将 @Composable Greeting(msg:String) 编译成了 Greeting(final String msg, Composer $composer, final int $changed)</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> static <span class="keyword">final</span> void Greeting(<span class="keyword">final</span> String msg, Composer $composer,</span><br><span class="line"> <span class="keyword">final</span> int $changed) &#123;</span><br><span class="line"></span><br><span class="line">  $composer = $composer.startRestartGroup(-<span class="number">1948405856</span>);</span><br><span class="line"></span><br><span class="line">  int $dirty = $changed;</span><br><span class="line">  <span class="keyword">if</span> (($changed &amp; <span class="number">14</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">     $dirty = $changed | ($composer.changed(msg) ? <span class="number">4</span> : <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (($dirty &amp; <span class="number">11</span>) == <span class="number">2</span> &amp;&amp; $composer.getSkipping()) &#123;</span><br><span class="line">     $composer.skipToGroupEnd();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     TextKt.Text-fLXpl1I(msg, $composer, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65534</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ScopeUpdateScope var10000 = $composer.endRestartGroup();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (var10000 != <span class="literal">null</span>) &#123;</span><br><span class="line">     var10000.updateScope((Function2)(new Function2() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> void invoke(<span class="meta">@Nullable</span> Composer $composer, int $force) &#123;</span><br><span class="line">           MainActivityKt.Greeting(msg, $composer, $changed | <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上表明每个 Composable 函数其实都对应了一个 ScopeUpdateScope，通过监听来实现重组。</p>
<p>其中 Compose 中 State 的读、写行为是通过 Snapshot（状态快照系统）监听。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Stable</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">MutableState</span>&lt;<span class="type">T</span>&gt; : <span class="type">State</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> value: T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> MutableState<span class="type">&lt;T&gt;</span>.<span class="title">setValue</span><span class="params">(thisObj: <span class="type">Any</span>?, property: <span class="type">KProperty</span>&lt;*&gt;, value: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.value = value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">SnapshotMutableStateImpl</span>&lt;<span class="type">T</span>&gt;(</span><br><span class="line">    value: T,</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> policy: SnapshotMutationPolicy&lt;T&gt;</span><br><span class="line">) : StateObject, SnapshotMutableState&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> value: T</span><br><span class="line">        <span class="keyword">get</span>() = next.readable(<span class="keyword">this</span>).value</span><br><span class="line">        <span class="keyword">set</span>(value) = next.withCurrent &#123;</span><br><span class="line">            <span class="keyword">if</span> (!policy.equivalent(it.value, value)) &#123;</span><br><span class="line">                next.overwritable(<span class="keyword">this</span>, it) &#123; <span class="keyword">this</span>.value = value &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> next: StateStateRecord&lt;T&gt; = StateStateRecord(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : StateRecord, R&gt;</span> T.<span class="title">overwritable</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    state: <span class="type">StateObject</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    candidate: <span class="type">T</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    block: <span class="type">T</span>.() -&gt; <span class="type">R</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: R &#123;</span><br><span class="line">    <span class="keyword">var</span> snapshot: Snapshot = snapshotInitializer</span><br><span class="line">    <span class="keyword">return</span> sync &#123;</span><br><span class="line">        snapshot = Snapshot.current</span><br><span class="line">        <span class="keyword">this</span>.overwritableRecord(state, snapshot, candidate).block() <span class="comment">// 更新 next</span></span><br><span class="line">    &#125;.also &#123;</span><br><span class="line">        notifyWrite(snapshot, state) <span class="comment">// 写入通知</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本质上，它其实就是通过自定义 Getter、Setter 来实现的。当我们定义的 state 变量变化的时候，Compose 可以通过自定义的 Setter 捕获到这一行为，从而调用 ScopeUpdateScope 当中的监听，触发重组。</p>
<p>然后我们看到上面的 notifyWrite 方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PublishedApi</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">notifyWrite</span><span class="params">(snapshot: <span class="type">Snapshot</span>, state: <span class="type">StateObject</span>)</span></span> &#123;</span><br><span class="line">    snapshot.writeObserver?.invoke(state)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以看到快照系统拥有 writeObserver ，事实上他还有 readObserver</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">composing</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        composition: <span class="type">ControlledComposition</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        modifiedValues: <span class="type">IdentityArraySet</span>&lt;<span class="type">Any</span>&gt;?,</span></span></span><br><span class="line"><span class="params"><span class="function">        block: () -&gt; <span class="type">T</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: T &#123;</span><br><span class="line">        <span class="keyword">val</span> snapshot = Snapshot.takeMutableSnapshot(</span><br><span class="line">            readObserverOf(composition), writeObserverOf(composition, modifiedValues)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> snapshot.enter(block)</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            applyAndCheck(snapshot)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">recordReadOf</span><span class="params">(value: <span class="type">Any</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!areChildrenComposing) &#123;</span><br><span class="line">            composer.currentRecomposeScope?.let &#123;</span><br><span class="line">                it.used = <span class="literal">true</span></span><br><span class="line">                observations.add(value, it)</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">recordWriteOf</span><span class="params">(value: <span class="type">Any</span>)</span></span> = synchronized(lock) &#123;</span><br><span class="line">        invalidateScopeOfLocked(value)</span><br><span class="line"></span><br><span class="line">        derivedStates.forEachScopeOf(value) &#123;</span><br><span class="line">            invalidateScopeOfLocked(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">invalidateScopeOfLocked</span><span class="params">(value: <span class="type">Any</span>)</span></span> &#123;</span><br><span class="line">          observations.forEachScopeOf(value) &#123; scope -&gt;</span><br><span class="line">            <span class="keyword">if</span> (scope.invalidateForResult(value) == InvalidationResult.IMMINENT) &#123;</span><br><span class="line">                observationsProcessed.add(value, scope)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>readObserverOf</code> 来记录哪些 <code>scope  </code>使用了此 <code>state</code> ，而 <code>writeObserverOf</code> 而写入时会找出对应使用此 <code>state</code> 的 <code>scope</code> 使其 <code>invalidate</code> ，然后对于这些 <code>scope</code> 执行重组</p>
<h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h4><p>有了以上知识，我们就可以理解官方文档性能优化中的<a target="_blank" rel="noopener" href="https://developer.android.google.cn/jetpack/compose/performance#defer-reads">尽可能延后读取</a>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">SnackDetail</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    Box(Modifier.fillMaxSize()) &#123; <span class="comment">// Recomposition Scope Start</span></span><br><span class="line">        <span class="keyword">val</span> scroll = rememberScrollState(<span class="number">0</span>)</span><br><span class="line">        Title(snack, scroll.value)</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="comment">// Recomposition Scope End</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">Title</span><span class="params">(snack: <span class="type">Snack</span>, scroll: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">val</span> offset = with(LocalDensity.current) &#123; scroll.toDp() &#125;</span><br><span class="line"></span><br><span class="line">    Column(</span><br><span class="line">        modifier = Modifier</span><br><span class="line">            .offset(y = offset)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">SnackDetail</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    Box(Modifier.fillMaxSize()) &#123; <span class="comment">// Recomposition Scope Start</span></span><br><span class="line">        <span class="keyword">val</span> scroll = rememberScrollState(<span class="number">0</span>)</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        Title(snack) &#123; scroll.value &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="comment">// Recomposition Scope End</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">Title</span><span class="params">(snack: <span class="type">Snack</span>, scrollProvider: () -&gt; <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> offset = with(LocalDensity.current) &#123; scrollProvider().toDp() &#125;</span><br><span class="line">    Column(</span><br><span class="line">        modifier = Modifier</span><br><span class="line">            .offset(y = offset)</span><br><span class="line">    ) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>状态读取发生在哪个 Scope，状态更新的时候，哪个 Scope 就发生重组</strong>。</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2022/12/23/How-does-a-c-program-execute/"><img class="prev-cover" src="/img/banner.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">How does a c program execute</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">muuuuu</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mumu12641"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/mumu12641" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:pengbin020813@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#From-View-To-Jetpack-Compose"><span class="toc-number">1.</span> <span class="toc-text">From View To Jetpack Compose</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F-View"><span class="toc-number">1.1.</span> <span class="toc-text">原生 View</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Window%E3%80%81Activity%E3%80%81DecorView%E3%80%81ViewRoot"><span class="toc-number">1.1.1.</span> <span class="toc-text">Window、Activity、DecorView、ViewRoot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setContentView"><span class="toc-number">1.1.2.</span> <span class="toc-text">setContentView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Measure"><span class="toc-number">1.1.3.</span> <span class="toc-text">Measure</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MeasureSpec"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">MeasureSpec</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Layout"><span class="toc-number">1.1.4.</span> <span class="toc-text">Layout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Draw"><span class="toc-number">1.1.5.</span> <span class="toc-text">Draw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-View"><span class="toc-number">1.1.6.</span> <span class="toc-text">自定义 View</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jetpack-Compose"><span class="toc-number">1.2.</span> <span class="toc-text">Jetpack Compose</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F-UI"><span class="toc-number">1.2.1.</span> <span class="toc-text">声明式 UI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E5%90%88-ViewModel-%E5%92%8C-Flow-%E9%A3%9F%E7%94%A8"><span class="toc-number">1.2.3.</span> <span class="toc-text">配合 ViewModel 和 Flow 食用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E7%BB%84%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.2.4.</span> <span class="toc-text">重组原理以及性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Composable-%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">Composable 的本质</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">性能优化</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/banner.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By muuuuu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div></div></body></html>